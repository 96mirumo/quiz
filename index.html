<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Study Log</title>
    <style>
        :root { --bg: #ffffff; --text: #333; --border: #eee; --accent: #444; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; min-height: 90vh; }
        .hidden { display: none !important; }
        
        /* 메뉴 디자인 */
        .menu-card { 
            background: #fff; border: 1px solid var(--border); border-radius: 8px; 
            padding: 15px; margin-bottom: 10px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .score-badge { font-size: 0.75rem; color: #888; background: #f9f9f9; padding: 2px 8px; border-radius: 10px; }
        .unit-group { margin-bottom: 25px; }
        .group-label { font-size: 0.8rem; color: #999; margin: 0 0 8px 5px; font-weight: bold; }

        /* 퀴즈 UI */
        .q-card { border: 1px solid var(--border); padding: 20px; border-radius: 8px; text-align: center; margin-top: 10px; }
        .q-text { font-size: 1.05rem; font-weight: 600; margin-bottom: 25px; word-break: keep-all; }
        
        input[type="text"] { 
            width: 90%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; 
            font-size: 1rem; margin-bottom: 15px; text-align: center; outline: none;
        }
        /* 객관식 버튼 스타일 및 포커스 효과 */
        .option-btn { 
            display: block; width: 100%; padding: 12px; margin-bottom: 8px; 
            border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; text-align: left;
            outline: none; transition: background 0.2s;
        }
        .option-btn:focus { background: #f0f0f0; border-color: #bbb; }
        .option-btn.selected { background: #eee; border-color: #999; }
        
        .btn-row { display: flex; gap: 8px; margin-top: 15px; }
        .btn { flex: 1; padding: 14px; border-radius: 4px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; font-size: 0.9rem; }
        .btn-next { background: var(--accent); color: #fff; border: none; }
        
        .status-msg { height: 20px; font-size: 0.85rem; margin-bottom: 10px; font-weight: bold; }
        .nav-link { display: block; text-align: center; margin-top: 30px; color: #aaa; font-size: 0.8rem; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div id="view-menu">
            <div style="height: 20px;"></div>
            <div class="unit-group">
                <div class="menu-card" onclick="resumeLast()" style="background:#444; color:#fff; border:none;">
                    <div>이전 문제 이어서 풀기</div>
                    <small id="resume-info" style="opacity:0.7;">기록 없음</small>
                </div>
                <div class="menu-card" onclick="startWrongAnswers()">
                    <div style="color:#666;">오답 노트 확인</div>
                    <small id="wrong-count" style="color:#999;">0개</small>
                </div>
            </div>
            <div class="unit-group">
                <div class="group-label">SECTION 01. 소프트웨어 구축</div>
                <div id="set-list-1"></div>
            </div>
            <div id="other-units"></div>
        </div>

        <div id="view-quiz" class="hidden">
            <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#aaa; margin-bottom:10px;">
                <span id="display-title"></span>
                <span id="display-progress"></span>
            </div>
            <div class="q-card">
                <div id="status-msg" class="status-msg"></div>
                <div id="q-text" class="q-text"></div>
                
                <div id="area-subjective">
                    <input type="text" id="user-ans" placeholder="정답 입력" autocomplete="off">
                </div>
                <div id="area-objective" class="hidden"></div>
                <div id="hint-box" class="hidden" style="background:#f9f9f9; padding:10px; font-size:0.85rem; margin:10px 0; border:1px dashed #ddd; text-align: left;"></div>

                <div class="btn-row" id="row-check">
                    <button class="btn" onclick="toggleHint()">Info</button>
                    <button class="btn" id="btn-verify" onclick="checkAnswer()">Verify</button>
                </div>
                <div class="btn-row hidden" id="row-next">
                    <button class="btn" onclick="toggleHint()">Info</button>
                    <button class="btn btn-next" onclick="nextQuestion()">Next Stage</button>
                </div>
            </div>
            <div class="nav-link" onclick="goHome()">목록으로 돌아가기</div>
        </div>
    </div>

    <script>
        const allQuestions = [
            { q: "소프트웨어 공학의 3R 중 '분석 -> 재구성 -> 역공학 -> 이관'의 절차를 가지는 것은?", a: ["재공학"], h: "Re-Engineering", type: "S" },
            { q: "애자일 방법론 중 XP의 5가지 핵심 가치가 아닌 것은?", a: ["가시성"], opts: ["용기", "존중", "가시성", "피드백"], h: "용단커피존 (용기, 단순성, 커뮤니케이션, 피드백, 존중)", type: "O" },
            { q: "Rayleigh-Norden 곡선을 기초로 하는 수학적 산정 모델은?", a: ["putnam", "푸트남"], h: "SLIM 도구 사용", type: "S" },
            { q: "요구사항 개발 프로세스: 도출 -> ( ) -> 명세 -> 확인. 괄호는?", a: ["분석"], h: "도분명확", type: "S" },
            { q: "비동기식 메시지 전송 미들웨어는?", a: ["MOM"], h: "Message Oriented Middleware", type: "S" },
            { q: "UML 관계 중 전체 객체가 소멸하면 부분 객체도 소멸하는 강한 포함 관계는?", a: ["합성 관계", "합성"], h: "Composition", type: "S" },
            { q: "사용자 시점의 시스템 기능을 표현하는 UML 다이어그램은?", a: ["유스케이스", "Use Case"], h: "Actor와 System 간 상호작용", type: "S" },
            { q: "GoF 패턴 중 생성 패턴에 해당하는 것은?", a: ["Builder"], opts: ["Adapter", "Facade", "Builder", "Proxy"], h: "추빌팩프싱", type: "O" },
            { q: "자식 클래스가 부모 클래스를 대체할 수 있어야 한다는 객체지향 설계 원칙은?", a: ["LSP", "리스코프 치환 원칙"], h: "Liskov Substitution Principle", type: "S" },
            { q: "누구나 쉽게 배우고 익힐 수 있어야 함을 의미하는 UI 설계 원칙은?", a: ["학습성"], h: "Understandability", type: "S" }
        ];

        let currentSet = [];
        let curIdx = 0;
        let setNum = 0;
        let isWrongMode = false;
        let scoreMap = {};

        function renderMenu() {
            const setList1 = document.getElementById('set-list-1');
            setList1.innerHTML = '';
            for(let i=1; i<=3; i++) {
                const s = localStorage.getItem(`score_1_${i}`) || "-";
                setList1.innerHTML += `
                    <div class="menu-card" onclick="startSet(1, ${i})">
                        <div class="unit-title">세트 0${i}</div>
                        <div class="score-badge">${s}점</div>
                    </div>`;
            }
            const lastU = localStorage.getItem('last_unit');
            const lastS = localStorage.getItem('last_set');
            document.getElementById('resume-info').innerText = lastU ? `1단원 세트 ${lastS} 풀이 중` : "기록 없음";
            document.getElementById('wrong-count').innerText = JSON.parse(localStorage.getItem('wrong_list') || "[]").length + "개";
        }

        // 문제 랜덤 셔플 함수
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startSet(u, s, resumeIdx = 0) {
            setNum = s;
            curIdx = resumeIdx;
            isWrongMode = false;
            // 세트 진입 시마다 확실하게 랜덤 셔플
            currentSet = shuffle([...allQuestions]); 
            initQuiz();
        }

        function initQuiz() {
            document.getElementById('view-menu').classList.add('hidden');
            document.getElementById('view-quiz').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const data = isWrongMode ? JSON.parse(localStorage.getItem('wrong_list')) : currentSet;
            const q = data[curIdx];
            document.getElementById('display-title').innerText = isWrongMode ? "오답 복습" : `1단원 세트 ${setNum}`;
            document.getElementById('display-progress').innerText = `${curIdx+1}/${data.length}`;
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('status-msg').innerText = '';
            document.getElementById('hint-box').classList.add('hidden');
            document.getElementById('row-next').classList.add('hidden');
            document.getElementById('row-check').classList.remove('hidden');

            if(!isWrongMode) {
                localStorage.setItem('last_unit', 1);
                localStorage.setItem('last_set', setNum);
                localStorage.setItem('last_idx', curIdx);
                localStorage.setItem('saved_set', JSON.stringify(currentSet)); // 현재 셔플된 세트 저장
            }

            if(q.type === "S") {
                document.getElementById('area-subjective').classList.remove('hidden');
                document.getElementById('area-objective').classList.add('hidden');
                const input = document.getElementById('user-ans');
                input.value = '';
                setTimeout(() => input.focus(), 100);
            } else {
                document.getElementById('area-subjective').classList.add('hidden');
                const objArea = document.getElementById('area-objective');
                objArea.classList.remove('hidden');
                objArea.innerHTML = '';
                q.opts.forEach((opt, idx) => {
                    objArea.innerHTML += `<button class="option-btn" id="opt-${idx}" onclick="checkObjective('${opt}')">${opt}</button>`;
                });
                setTimeout(() => document.getElementById('opt-0').focus(), 100);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('view-quiz').classList.contains('hidden')) return;

            // 엔터키 처리
            if (e.key === 'Enter') {
                const rowCheck = document.getElementById('row-check');
                if (!rowCheck.classList.contains('hidden')) {
                    if (currentSet[curIdx].type === "S") checkAnswer();
                    else if (document.activeElement.classList.contains('option-btn')) document.activeElement.click();
                } else {
                    nextQuestion();
                }
            } 
            // 컨트롤키 힌트
            else if (e.key === 'Control') {
                e.preventDefault();
                toggleHint();
            }
            // 방향키 처리 (객관식)
            else if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && currentSet[curIdx].type === "O") {
                const buttons = document.querySelectorAll('.option-btn');
                let index = Array.from(buttons).indexOf(document.activeElement);
                if (e.key === 'ArrowDown') index = (index + 1) % buttons.length;
                else index = (index - 1 + buttons.length) % buttons.length;
                buttons[index].focus();
                e.preventDefault();
            }
        });

        function checkAnswer() {
            const input = document.getElementById('user-ans');
            const user = input.value.trim().toLowerCase().replace(/\s+/g, '');
            const data = isWrongMode ? JSON.parse(localStorage.getItem('wrong_list')) : currentSet;
            const q = data[curIdx];
            const isCorrect = q.a.some(ans => ans.toLowerCase().replace(/\s+/g, '') === user);
            showResult(isCorrect);
        }

        function checkObjective(val) {
            const data = isWrongMode ? JSON.parse(localStorage.getItem('wrong_list')) : currentSet;
            const q = data[curIdx];
            showResult(q.a.includes(val));
        }

        function showResult(isCorrect) {
            const msg = document.getElementById('status-msg');
            const q = (isWrongMode ? JSON.parse(localStorage.getItem('wrong_list')) : currentSet)[curIdx];
            if(!isWrongMode && scoreMap[`${setNum}_${curIdx}`] === undefined) scoreMap[`${setNum}_${curIdx}`] = isCorrect;

            if(isCorrect) {
                msg.innerText = "✓ 확인됨";
                msg.style.color = "#aaa";
            } else {
                msg.innerText = `✕ 미일치 (정답: ${q.a[0]})`;
                msg.style.color = "#d9534f";
                saveWrong(q);
            }
            document.getElementById('row-check').classList.add('hidden');
            document.getElementById('row-next').classList.remove('hidden');
        }

        function saveWrong(q) {
            let list = JSON.parse(localStorage.getItem('wrong_list') || "[]");
            if(!list.some(item => item.q === q.q)) {
                list.push(q);
                localStorage.setItem('wrong_list', JSON.stringify(list));
            }
        }

        function nextQuestion() {
            const data = isWrongMode ? JSON.parse(localStorage.getItem('wrong_list')) : currentSet;
            if(curIdx < data.length - 1) {
                curIdx++;
                loadQuestion();
            } else {
                if(!isWrongMode) {
                    const score = Math.round((Object.values(scoreMap).filter(v=>v).length / data.length) * 100);
                    localStorage.setItem(`score_1_${setNum}`, score);
                    alert(`종료! 점수: ${score}점`);
                }
                goHome();
            }
        }

        function resumeLast() {
            const u = localStorage.getItem('last_unit');
            const s = localStorage.getItem('last_set');
            const i = localStorage.getItem('last_idx');
            const saved = localStorage.getItem('saved_set');
            if(u && s && saved) {
                setNum = parseInt(s);
                curIdx = parseInt(i);
                currentSet = JSON.parse(saved);
                isWrongMode = false;
                initQuiz();
            } else { alert("기록이 없습니다."); }
        }

        function startWrongAnswers() {
            const list = JSON.parse(localStorage.getItem('wrong_list') || "[]");
            if(list.length === 0) return alert("기록 없음");
            isWrongMode = true; curIdx = 0; initQuiz();
        }

        function toggleHint() {
            const data = (isWrongMode ? JSON.parse(localStorage.getItem('wrong_list')) : currentSet)[curIdx];
            const box = document.getElementById('hint-box');
            box.innerText = data.h;
            box.classList.toggle('hidden');
            if(data.type === "S") document.getElementById('user-ans').focus();
        }

        function goHome() { location.reload(); }
        renderMenu();
    </script>
</body>
</html>
