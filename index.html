<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Viewer</title>
    <style>
        :root { --bg: #ffffff; --text: #333333; --border: #dddddd; --hover: #f9f9f9; --correct: #666666; --wrong: #ff0000; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.5; }
        #app { max-width: 650px; margin: 0 auto; border: 1px solid var(--border); padding: 25px; min-height: 500px; }
        .hidden { display: none; }
        button { background: #fff; border: 1px solid var(--border); padding: 12px; cursor: pointer; margin: 4px 0; font-size: 14px; text-align: left; width: 100%; }
        button:hover { background: var(--hover); }
        .nav-link { font-size: 12px; color: #999; border: none; background: none; text-decoration: underline; cursor: pointer; width: auto; padding: 0; margin-bottom: 20px; }
        input[type="text"] { border: 1px solid var(--border); padding: 12px; width: 100%; box-sizing: border-box; outline: none; margin-bottom: 10px; font-size: 16px; }
        .hint-box { color: #777; font-size: 13px; border: 1px dashed #ccc; padding: 10px; margin: 15px 0; }
        .status-bar { display: flex; justify-content: space-between; font-size: 11px; color: #bbb; margin-bottom: 15px; }
        .ans-btn { background: #555; color: #fff; text-align: center; }
        .unit-title { font-weight: bold; margin: 15px 0 5px 0; font-size: 15px; }
        .recent-score { font-size: 11px; color: #888; margin-left: 10px; }
        .feedback { font-weight: bold; margin: 10px 0; padding: 10px; border: 1px solid var(--border); }
        .review-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .scroll-area { max-height: 400px; overflow-y: auto; padding-right: 10px; }
    </style>
</head>
<body>

<div id="app">
    <div id="unit-page">
        <div class="unit-title">1. 소프트웨어 설계</div>
        <div id="unit1-sets"></div>
        
        <div class="unit-title">2. 소프트웨어 개발</div>
        <div id="unit2-sets"></div>

        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <button onclick="resumeQuiz()">이전 문제 이어풀기</button>
            <button onclick="showWrongNote()">오답 노트 관리</button>
        </div>
    </div>

    <div id="quiz-page" class="hidden">
        <div class="status-bar">
            <span onclick="confirmGoHome()" style="cursor:pointer;">[메인으로]</span>
            <span id="quiz-info"></span>
        </div>
        <div id="q-content">
            <p id="q-text" style="font-weight: bold;"></p>
            <div id="obj-options"></div>
            <div id="sub-input-box" class="hidden">
                <input type="text" id="ans-input" placeholder="답안 입력 (Enter)">
                <button class="ans-btn" onclick="submitSubAnswer()">제출</button>
            </div>
            
            <div id="feedback-area" class="hidden">
                <div id="feedback-text" class="feedback"></div>
                <button class="ans-btn" id="next-btn" onclick="nextQuestion()">다음 문제 (Enter)</button>
            </div>

            <div id="hint-area" class="hidden" class="hint-box">
                <p id="hint-text" class="hint-box"></p>
            </div>
        </div>
        <div id="quiz-nav-btns" style="margin-top: 30px; display: flex; gap: 10px;">
            <button onclick="prevQuestion()" style="width:50%; text-align:center;">이전 (←)</button>
            <button onclick="toggleHint()" style="width:50%; text-align:center;">힌트 (H)</button>
        </div>
    </div>

    <div id="result-page" class="hidden">
        <h2 id="score-summary"></h2>
        <div class="scroll-area" id="review-list"></div>
        <button onclick="goHome()" style="text-align:center; margin-top:20px;">메인 화면으로</button>
    </div>

    <div id="wrong-page" class="hidden">
        <button class="nav-link" onclick="goHome()">← 메인으로</button>
        <div id="wrong-list" class="scroll-area"></div>
    </div>
</div>

<script>
    // 문제 데이터 (단원별 3세트씩 총 60문항 샘플 구조)
    const questions = [
        { unit: 1, set: 1, type: "obj", q: "UI 설계 원칙 중 사용자의 목적을 정확하게 달성해야 한다는 원칙은?", options: ["직관성", "유효성", "학습성", "유연성"], ans: 1, hint: "정확하고 완벽한 수행을 뜻합니다." },
        { unit: 1, set: 1, type: "sub", q: "시스템 구조를 설계하는 상위 설계의 핵심 모델은?", ans: "아키텍처", hint: "영어로는 Architecture입니다." },
        // ... 생략된 문항들은 동일한 형식으로 60개까지 추가 가능
        { unit: 2, set: 1, type: "obj", q: "결합도가 가장 강한 것(안좋은 것)은?", options: ["내용", "공통", "외부", "제어"], ans: 0, hint: "가장 직접적으로 내부를 참조합니다." },
        { unit: 2, set: 1, type: "sub", q: "소스 코드를 보지 않고 테스트하는 기법은?", ans: "블랙박스 테스트", hint: "기능 위주의 테스트입니다." }
    ];

    let state = { unit: 0, set: 0, idx: 0, quizList: [], answers: [], firstAttempts: [], logs: [] };
    let wrongNote = JSON.parse(localStorage.getItem('wrongNote')) || [];
    let recentScores = JSON.parse(localStorage.getItem('recentScores')) || {};

    // 초기 메인 화면 세팅
    function initMain() {
        renderSetList(1, 'unit1-sets');
        renderSetList(2, 'unit2-sets');
    }

    function renderSetList(unit, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        [1, 2, 3].forEach(s => {
            const scoreKey = `${unit}-${s}`;
            const score = recentScores[scoreKey] !== undefined ? `${recentScores[scoreKey]}점` : '기록없음';
            const btn = document.createElement('button');
            btn.innerHTML = `세트 ${s} <span class="recent-score">${score}</span>`;
            btn.onclick = () => startQuiz(unit, s);
            container.appendChild(btn);
        });
    }

    // 퀴즈 시작
    function startQuiz(u, s, resumeIdx = 0) {
        state.unit = u; state.set = s; state.idx = resumeIdx;
        state.quizList = questions.filter(q => q.unit === u && q.set === s);
        state.answers = new Array(state.quizList.length).fill(null);
        state.firstAttempts = new Array(state.quizList.length).fill(true);
        state.logs = [];
        
        document.getElementById('unit-page').classList.add('hidden');
        document.getElementById('quiz-page').classList.remove('hidden');
        loadQuestion();
    }

    function loadQuestion() {
        const q = state.quizList[state.idx];
        document.getElementById('quiz-info').innerText = `${state.idx + 1} / 10`;
        document.getElementById('q-text').innerText = q.q;
        
        // 초기화
        document.getElementById('hint-area').classList.add('hidden');
        document.getElementById('hint-text').innerText = q.hint;
        document.getElementById('feedback-area').classList.add('hidden');
        document.getElementById('quiz-nav-btns').classList.remove('hidden');
        
        const objBox = document.getElementById('obj-options');
        const subBox = document.getElementById('sub-input-box');
        objBox.innerHTML = '';
        
        if (q.type === 'obj') {
            subBox.classList.add('hidden');
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.innerText = `${i+1}. ${opt}`;
                btn.onclick = () => checkImmediateAnswer(i);
                objBox.appendChild(btn);
            });
        } else {
            subBox.classList.remove('hidden');
            const input = document.getElementById('ans-input');
            input.value = '';
            setTimeout(() => input.focus(), 50);
        }
        saveProgress();
    }

    // 정답 즉시 확인 로직
    function checkImmediateAnswer(userAns) {
        const q = state.quizList[state.idx];
        const isCorrect = (q.type === 'obj') ? (userAns === q.ans) : (userAns === q.ans);
        const feedbackText = document.getElementById('feedback-text');
        
        // 피드백 표시
        document.getElementById('feedback-area').classList.remove('hidden');
        document.getElementById('quiz-nav-btns').classList.add('hidden'); // 정답 확인 중엔 이동버튼 숨김
        
        if (isCorrect) {
            feedbackText.innerText = "정답입니다!";
            feedbackText.style.color = "var(--correct)";
        } else {
            const correctStr = q.type === 'obj' ? `${q.ans + 1}. ${q.options[q.ans]}` : q.ans;
            feedbackText.innerText = `오답입니다. 정답: ${correctStr}`;
            feedbackText.style.color = "var(--wrong)";
        }

        // 최초 시도 점수 및 로그 기록
        if (state.firstAttempts[state.idx]) {
            state.answers[state.idx] = isCorrect;
            state.firstAttempts[state.idx] = false;
            state.logs.push({ q: q.q, isCorrect, userAns: (q.type === 'obj' ? q.options[userAns] : userAns), ans: (q.type === 'obj' ? q.options[q.ans] : q.ans) });
            
            if (!isCorrect) addToWrongNote(q);
            else checkWrongNoteReduction(q);
        }
        
        document.getElementById('next-btn').focus();
    }

    function submitSubAnswer() {
        const val = document.getElementById('ans-input').value.trim();
        if (!val) return;
        checkImmediateAnswer(val);
    }

    function nextQuestion() {
        if (state.idx < state.quizList.length - 1) {
            state.idx++;
            loadQuestion();
        } else {
            showFinalReport();
        }
    }

    function prevQuestion() {
        if (state.idx > 0) { state.idx--; loadQuestion(); }
    }

    // 최종 점수 및 문항별 리포트
    function showFinalReport() {
        const score = state.answers.filter(a => a === true).length * 10;
        recentScores[`${state.unit}-${state.set}`] = score;
        localStorage.setItem('recentScores', JSON.stringify(recentScores));

        document.getElementById('quiz-page').classList.add('hidden');
        document.getElementById('result-page').classList.remove('hidden');
        document.getElementById('score-summary').innerText = `총점: ${score}점`;

        const reviewList = document.getElementById('review-list');
        reviewList.innerHTML = state.logs.map((log, i) => `
            <div class="review-item">
                <div style="color:${log.isCorrect ? 'var(--correct)' : 'var(--wrong)'}">
                    ${i+1}. ${log.isCorrect ? '[정답]' : '[오답]'} ${log.q}
                </div>
                <div style="font-size:13px; margin-top:5px;">
                    입력: ${log.userAns} / 정답: ${log.ans}
                </div>
            </div>
        `).join('');
        
        localStorage.removeItem('saveData');
    }

    function toggleHint() { document.getElementById('hint-area').classList.toggle('hidden'); }
    function saveProgress() { localStorage.setItem('saveData', JSON.stringify({ u: state.unit, s: state.set, i: state.idx })); }
    
    function resumeQuiz() {
        const s = JSON.parse(localStorage.getItem('saveData'));
        if (s) startQuiz(s.u, s.s, s.i);
        else alert('저장된 데이터가 없습니다.');
    }

    function addToWrongNote(q) {
        if (!wrongNote.find(w => w.q === q.q)) {
            wrongNote.push({ ...q, count: 0 });
            localStorage.setItem('wrongNote', JSON.stringify(wrongNote));
        }
    }

    function checkWrongNoteReduction(q) {
        let item = wrongNote.find(w => w.q === q.q);
        if (item) {
            item.count++;
            if (item.count >= 3) wrongNote = wrongNote.filter(w => w.q !== q.q);
            localStorage.setItem('wrongNote', JSON.stringify(wrongNote));
        }
    }

    function showWrongNote() {
        document.getElementById('unit-page').classList.add('hidden');
        document.getElementById('wrong-page').classList.remove('hidden');
        const list = document.getElementById('wrong-list');
        list.innerHTML = wrongNote.map(w => `
            <div class="review-item">
                <div>${w.q}</div>
                <div style="font-size:12px; color:#888;">정답: ${w.type==='obj' ? w.options[w.ans] : w.ans} | 연속성공: ${w.count}/3</div>
            </div>
        `).join('');
    }

    function goHome() { location.reload(); }
    function confirmGoHome() { if(confirm("진행 상황이 저장됩니다. 메인으로 갈까요?")) goHome(); }

    // 단축키 설정
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('quiz-page').classList.contains('hidden')) return;
        
        // 피드백창이 열려있을 때 Enter는 다음 문제로
        if (!document.getElementById('feedback-area').classList.contains('hidden')) {
            if (e.key === 'Enter') nextQuestion();
            return;
        }

        if (e.key === 'ArrowLeft') prevQuestion();
        if (e.key === 'Enter') {
            if (!document.getElementById('sub-input-box').classList.contains('hidden')) submitSubAnswer();
        }
        if (e.key.toLowerCase() === 'h') toggleHint();
    });

    initMain();
</script>
</body>
</html>
